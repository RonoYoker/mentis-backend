<link
  rel="stylesheet"
  media="screen, print"
  href="/static/mentis/css/datatables.bundle.css"
/>
<script src="/static/mentis/js/datatables.bundle.js"></script>
<script src="/static/mentis/js/datatables.export.js"></script>
<script src="/static/mentis/js/underscore-1.6.0.min.js"></script>
<script src="/static/mentis/js/select2.bundle.js"></script>
<link
  rel="stylesheet"
  media="screen, print"
  href="/static/mentis/css/select2.bundle.css"
/>

<style type="text/css">
  .form-field-custom {
    font-weight: bold;
    font-size: 14px;
  }

  .catselect {
    font-size: 17px;
    line-height: 22px;
    width: 200px;
    display: none;
  }

  .fl {
    float: left;
  }

  .ui-datepicker {
    z-index: 9999999 !important;
  }

  .linkItem {
    float: left;
    background-color: #ccc;
    color: #222;
    border-radius: 2px;
    font-weight: bold;
    padding: 6px;
    margin-left: 20px;
    cursor: pointer;
    margin-top: 10px;
    font-size: 15px;
  }

  .dtr-data {
    text-transform: uppercase;
  }

  .smart-form .input input,
  .smart-form .select select,
  .smart-form .textarea textarea {
    font-size: 15px !important;
    font-weight: bold !important;
  }

  .optiontext {
    font-weight: bold !important;
  }

  .radio,
  .checkbox {
    float: left;
    margin-top: 0px !important;
    margin-bottom: 0px !important;
    padding-left: 35px !important;
  }

  .radio + .radio,
  .checkbox + .checkbox {
    margin: 0px !important;
  }

  .width20 {
    width: 20%;
  }

  .width15 {
    width: 15%;
  }

  .width30 {
    width: 30%;
  }

  .width60 {
    width: 60%;
  }

  .width100 {
    width: 100%;
  }

  #raw-item-div .form-control {
    color: #004d99 !important;
  }

  .bor-left {
    border: 1px solid #ddd;
    padding: 6px;
    font-weight: bold;
    background-color: #bbb;
    color: #000;
  }

  .bor-mid {
    border-top: 1px solid #ddd;
    border-bottom: 1px solid #ddd;
    padding: 3px 2px;
  }

  .left-col {
    width: 10%;
    float: left;
  }

  .mid-col {
    float: left;
  }
</style>
    <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCDCOXYvxljHSee6VIttrpWN_p27WrrTuo&libraries=places&callback=initMap"></script>
    <style>
        #map {
            height: 500px;
            width: 100%;
        }
        #search-container {
            margin: 10px 0;
            display: flex;
            gap: 10px;
        }
        #search-bar {
            flex: 1;
            padding: 10px;
            font-size: 16px;
        }
        #details {
            margin: 10px 0;
            font-family: Arial, sans-serif;
        }
    </style>

<div id="invoices-data-div" style="margin-top: 30px" class="row">
  <div class="col-xl-12">
    <div id="panel-1" class="panel">
      <div class="panel-hdr">
        <h2>
           <span class="fw-900"><i>Manage Profile</i></span>
        </h2>
        <div class="panel-toolbar">
          <button
            class="btn btn-panel"
            data-action="panel-collapse"
            data-toggle="tooltip"
            data-offset="0,10"
            data-original-title="Collapse"
          ></button>
          <button
            class="btn btn-panel"
            data-action="panel-fullscreen"
            data-toggle="tooltip"
            data-offset="0,10"
            data-original-title="Fullscreen"
          ></button>
          <button
            class="btn btn-panel"
            data-action="panel-close"
            data-toggle="tooltip"
            data-offset="0,10"
            data-original-title="Close"
          ></button>
        </div>
      </div>
<!--      <div class="panel-container show align-items-center justify-content-center" style="min-height: 60vh">-->
<!--<div class="col-12">-->
<!--                                            <div class="d-flex flex-column align-items-center justify-content-center p-4">-->
<!--                                                <img src="https://cdn.pixabay.com/photo/2015/10/05/22/37/blank-profile-picture-973460_1280.png" class="rounded-circle shadow-2 img-thumbnail" alt="" style="height:200px">-->
<!--                                                <div class="form-group col-xl-5 mt-4 p-3">-->
<!--                                                    <label class="form-label" for="example-email-2">Name</label>-->
<!--                                                    <input type="email" id="example-email-2" name="example-email-2" class="form-control" placeholder="Email">-->
<!--                                                  <label class="form-label" for="example-email-2">Email</label>-->
<!--                                                    <input type="email" id="example-email-2" name="example-email-2" class="form-control" placeholder="Email">-->
<!--                                                  <label class="form-label" for="example-email-2">Email</label>-->
<!--                                                    <input type="email" id="example-email-2" name="example-email-2" class="form-control" placeholder="Email">-->
<!--                                                </div>-->

<!--                                                </h5>-->
<!--                                            </div>-->
<!--                                        </div>-->
        <div class="d-flex flex-column align-items-center justify-content-center p-4 ">
        <div class="profile-form col-xl-6" id = "userData" >
            {% csrf_token %}

            <!-- Error message block -->
            {% if messages %}
            <div class="error-message">
                {% for message in messages %}
                    {{ message }}<br>
                {% endfor %}
            </div>
            {% endif %}

            <div class="profile-photo">
              {% if user.img %}
                <img src="{{ user.img }}" class="rounded-circle shadow-2 img-thumbnail" style="height:200px;width:200px" alt="https://cdn.pixabay.com/photo/2015/10/05/22/37/blank-profile-picture-973460_1280.png">
              {% else %}
              <img src="https://cdn.pixabay.com/photo/2015/10/05/22/37/blank-profile-picture-973460_1280.png" class="rounded-circle shadow-2 img-thumbnail" alt="" style="height:200px">
                {% endif %}

            </div>

            <div class="form-group" >
                <label for="photo" class="form-field-custom"></label>
                <input type="file" id="photo" name="photo" class="form-control" style="border:none">
            </div>

            <div class="form-group">
                <label for="name" class="form-field-custom">Name</label>
                <input type="text" id="name" name="name" class="form-control" value="{{ user.name }}" required>
            </div>

          <div class="form-group">
                <label for="exp-year" class="form-field-custom">Experience (Years/Months)</label>
            <div class="input-group">
                <input type="text" id="experience_years" aria-label="" class="form-control" placeholder="Years" value="{{ user.experience_years }}"  >
                <input type="text" id ="experience_months" aria-label="" class="form-control" placeholder="Months" value="{{ user.experience_months }}">
            </div>
            </div>

            <div class="form-group">
                <label for="about_me" class="form-field-custom">Introduction</label>
                <textarea id="about_me" name="about_me" class="form-control" rows="3" placeholder="Write a brief introduction...">{{ user.extra_info.about_me }}</textarea>
            </div>

            <div class="form-group">
                <label for="specialisations" class="form-field-custom">Specialisations</label>
                <select id="specialisations" name="specialisations" class="form-control select2" multiple="multiple">
                    {% for specialisation in specialisations %}
                        <option value="{{ specialisation }}" {% if specialisation in user.specialisations %}selected{% endif %}>{{ specialisation }}</option>
                    {% endfor %}
                </select>
            </div>

            <div class="form-group">
                <label for="registration_number" class="form-field-custom">Registration Number</label>
                <input type="text" id="registration_number" name="registration_no" class="form-control" value="{{ user.registration_number }}">
            </div>

            <div class="form-group">
                <label for="languages" class="form-field-custom">Languages</label>
                <select id="languages" name="languages" class="select2 select2-placeholder-multiple form-control select2-hidden-accessible" multiple="multiple">
                    {% for language in languages %}
                        <option value="{{ language }}"  data-select2-id="{{ language }}"{% if language in user.extra_info.languages %}selected{% endif %}>{{ language }}</option>
                    {% endfor %}
                </select>
            </div>

            <div class="form-group">
                <label for="city" class="form-field-custom">City</label>
                <select id="city" name="city" class="select2 select2-placeholder-multiple form-control select2-hidden-accessible">
                    {% for city in cities %}
                        <option value="{{ city }}"  data-select2-id="{{ city }}"{% if city in user.city %}selected{% endif %}>{{ city }}</option>
                    {% endfor %}
                </select>
            </div>

            <div class="form-group">
                <label for="location" class="form-field-custom">location</label>
               <div id="search-container">
                    <input id="search-bar" type="text" placeholder="Search for a location..." />
                </div>
                <div id="map"></div>
<!--                <div id="details">-->
<!--                    <div><strong>Coordinates:</strong> <span id="coordinates">Select a location</span></div>-->
<!--                     <div><strong>Address:</strong> <span id="address">None</span></div>-->
<!--                    <div><strong>Embed Link:</strong> <span id="embed-link"></span></div>-->
<!--        <div><strong>Shareable URL:</strong> <a id="shareable-url" href="#" target="_blank">None</a></div>                    <iframe id="embed-preview" width="100%" height="300" frameborder="0" style="border:0; margin-top: 10px;" allowfullscreen></iframe>-->
<!--                </div>-->
            </div>

            <div class="custom-control custom-switch form-group">
                <input type="checkbox" class="custom-control-input" id="active" >
                <label class="custom-control-label" for="active">Make Your Profile Active</label>
            </div>

            <button onclick="updateProfile()" class="btn btn-primary waves-effect waves-themed">Update Profile</button>
        </div>
    </div>
      </div>
    </div>
  </div>
</div>
<div
  class="toast hide"
  style="
    position: absolute;
    top: 50%;
    right: 45%;
    background-color: rgb(220 53 69);
    color: white;
    min-width: 250px;
    z-index: 2;
  "
  id="somethingWentWrongAlert"
  data-delay="2000"
>
  <div class="toast-header">
    <strong class="mr-auto">Alert</strong>
    <button
      type="button"
      class="ml-2 mb-1 close"
      data-dismiss="toast"
      aria-label="Close"
    >
      <span aria-hidden="true">&times;</span>
    </button>
  </div>
  <div class="toast-body">Somthing went wrong, Please try again.</div>
  <!-- <div class="toast-header">
<strong class="mr-auto" id="toastInfo">lmcklwkmeck</strong>
</div> -->
</div>
<div
  class="modal"
  id="moveToProdModal"
  tabindex="-1"
  role="dialog"
  aria-labelledby="myModalLabel"
  aria-hidden="false"
  style="background-color: rgba(0, 0, 0, 0.15)"
>
  <div class="modal-dialog modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header" style="padding-bottom: 0px">
        <h2 class="modal-title">Move configurations to Production</h2>
        <button
          type="button"
          class="close"
          data-dismiss="modal"
          aria-label="Close"
        >
          <span aria-hidden="true"><i class="fal fa-times"></i></span>
        </button>
      </div>
      <div class="modal-body">
        <h3>Current Active configurations</h3>
        <div style="height: 50vh; overflow-y: overlay">
          <table
            class="table m-0 table-bordered table-striped"
            id="table-example"
          >
            <thead>
              <tr>
                <th>Config key</th>
                <th>Version</th>
                <th>Created By</th>
                <th>Move to prod</th>
              </tr>
            </thead>
            <tbody id="currentActiveConfigTable"></tbody>
          </table>
        </div>
      </div>
      <div class="modal-footer">
        <button
          type="button"
          class="btn btn-secondary waves-effect waves-themed"
          data-dismiss="modal"
        >
          Close
        </button>
        <button
          type="button"
          class="btn btn-primary waves-effect waves-themed"
          onclick="moveToProd()"
        >
          Move to Prod
        </button>
      </div>
    </div>
  </div>

  <div id="screenLoader" style="display: none">
    <div
      class="position-absolute d-flex flex-column justify-content-center align-items-center h-100 w-100"
      style="z-index: 2; background-color: rgba(255, 255, 255, 0.7); top: 0"
    >
      <div class="spinner-border mb-2" role="status"></div>
      <div style="font-size: 16px">Loading...</div>
    </div>
  </div>
</div>
<div
  class="modal modal-alert fade show"
  id="moveToProdConfirmationModal"
  tabindex="-1"
  role="dialog"
  style="display: none; padding-right: 15px"
  aria-modal="true"
>
  <div class="modal-dialog modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          Please confirm that you want to move this config &nbsp;<span
            id="confirmationModalConfigKey"
          >
          </span>
          to prod!!
        </h5>
        <button
          type="button"
          class="close"
          data-dismiss="modal"
          aria-label="Close"
        >
          <span aria-hidden="true"><i class="fal fa-times"></i></span>
        </button>
      </div>
      <div class="modal-footer">
        <button
          type="button"
          class="btn btn-secondary waves-effect waves-themed"
          data-dismiss="modal"
        >
          Close
        </button>
        <button
          type="button"
          class="btn btn-primary waves-effect waves-themed"
          onclick="confirmAndProceed()"
        >
          Confirm & Proceed
        </button>
      </div>
    </div>
  </div>
</div>
<div
  class="toast hide"
  style="
    position: absolute;
    top: 50%;
    right: 45%;
    background-color: #090;
    color: white;
    min-width: 250px;
    z-index: 2;
  "
  id="successAlert"
  data-delay="2000"
>
  <div class="toast-header">
    <strong class="mr-auto">Alert</strong>
    <button
      type="button"
      class="ml-2 mb-1 close"
      data-dismiss="toast"
      aria-label="Close"
    >
      <span aria-hidden="true">&times;</span>
    </button>
  </div>
  <div class="toast-body">Profile Successfully Updated</div>
  <!-- <div class="toast-header">
<strong class="mr-auto" id="toastInfo">lmcklwkmeck</strong>
</div> -->
</div>

<script type="text/template" id="table-template">
  <% if(prod_access){ %>
  <button class="btn buttons-pdf buttons-html5 btn-outline-danger btn-sm mr-1" style="float: right;margin-top: 5px;color: #99898;" onclick="moveAllToProdButtonClick()">Move To Production</button>
  <% } %>
  <table id="datatable-invoice-data-<%=table_id%>" class="table table-bordered table-hover table-striped w-100">
    <thead class="bg-primary-600">
    <tr>
      <th class="new-col">ID</th>
      <th class="new-col">Config Key</th>
      <th class="new-col">Version</th>
      <th class="new-col">Active</th>
      <th class="new-col">Created By</th>
      <th class="new-col">Created On</th>
      <th class="new-col">View</th>
      <th class="new-col">Edit</th>
      <% if(prod_access){ %>
        <th class="new-col">Move To Prod</th>
      <% } %>
      <!-- <th class="new-col">Delete</th> -->
    </tr>
    </thead>
    <tbody>
    <%=table_html%>
    </tbody>
    <tfoot>
   <tr>
      <th class="new-col">ID</th>
      <th class="new-col">Config Key</th>
      <th class="new-col">Version</th>
      <th class="new-col">Active</th>
      <th class="new-col">Created By</th>
      <th class="new-col">Created On</th>
      <th class="new-col">View</th>
      <th class="new-col">Edit</th>

     <% if(prod_access){ %>
        <th class="new-col">Move To Prod</th>
      <% } %>
      <!-- <th class="new-col">Delete</th> -->
    </tr>
    </tfoot>
  </table>
</script>
<script>
        let map, marker, autocomplete, geocoder,lat,lng,address,embedLink,shareLink;

        // Initialize the map
        function initMap() {
            const defaultLocation = { lat: 28.7041, lng: 77.1025 }; // Default: San Francisco
            // Create the map
            map = new google.maps.Map(document.getElementById("map"), {
                center: defaultLocation,
                zoom: 12,
            });

            // Create a draggable marker
            marker = new google.maps.Marker({
                position: defaultLocation,
                map: map,
                draggable: true,
                title: "Drag to select a location",
            });

            // Initialize the geocoder
            geocoder = new google.maps.Geocoder();

            // Update details when the marker is dragged
            marker.addListener("dragend", () => {
                updateLocation(marker.getPosition());
            });

            // Add autocomplete to the search bar
            const searchBar = document.getElementById("search-bar");
            autocomplete = new google.maps.places.Autocomplete(searchBar, {
                fields: ["geometry"],
            });

            // Listen for place selection
            autocomplete.addListener("place_changed", () => {
                const place = autocomplete.getPlace();
                if (place.geometry && place.geometry.location) {
                    const location = place.geometry.location;
                    map.setCenter(location);
                    marker.setPosition(location);
                    updateLocation(location);
                }
            });

            // Add click event listener on the map
            map.addListener("click", (event) => {
                const clickedLocation = event.latLng;
                marker.setPosition(clickedLocation);
                updateLocation(clickedLocation);
            });
        }

        // Update coordinates, address, embed link, and shareable URL
        function updateLocation(location) {
             lat = location.lat().toFixed(6);
             lng = location.lng().toFixed(6);

            // Update coordinates
<!--            document.getElementById("coordinates").textContent = `Latitude: ${lat}, Longitude: ${lng}`;-->

            // Fetch and update address using geocoder
            geocoder.geocode({ location: location }, (results, status) => {
                if (status === "OK" && results[0]) {
                    address=results[0].formatted_address;
                } else {
                    document.getElementById("address").textContent = "Address not found";
                }
            });

            // Update embed link
             embedLink = `https://www.google.com/maps/embed/v1/view?key=AIzaSyCDCOXYvxljHSee6VIttrpWN_p27WrrTuo&center=${lat},${lng}&zoom=14`;

            // Update shareable URL
             shareLink = `https://www.google.com/maps?q=${lat},${lng}`;
        }
        </script>

        <script type="text/javascript">
  var lock = false;
  var pluginsDataMap = {};
  var tableCounter = 1;
  var user_bank_settings="";
  var apiBasePath = "";
  var currentEnvironment = "";
  var currentProject = "";
  var currentBank = "";
  var currentUser = "{{ user }}";
  var activeUser = "{{user.active}}"
  var currentActiveConfigs = [];
<!--  initMap();-->
  $(document).ready(function () {
            $('.select2').select2();
            if (activeUser == '1'){
                $("#active").click();
            }
        });

  $("#bankName").on("change", function () {
    $("#environment").parent().show();
    var environmentOptionsHtml = "<option value='' disabled selected></option>";
    for (const environment of Object.keys(user_bank_settings[this.value])) {
      environmentOptionsHtml += `<option value='${environment}'>${environment}</option>`;
    }
    $("#environment").html(environmentOptionsHtml);
    $("#project").parent().hide();
    $("#project").html("");
    currentBank = this.value;
  });
  $("#environment").on("change", function () {
    $("#project").parent().show();
    const bank = $("#bankName").val();
    var projectOptionsHtml = "<option value='' disabled selected></option>";
    for (const project of Object.keys(user_bank_settings[bank][this.value])) {
      projectOptionsHtml += `<option value='${project}'>${project}</option>`;
    }
    $("#project").html(projectOptionsHtml);
    currentEnvironment = this.value;
  });
  $("#project").on("change", function () {
    const bank = $("#bankName").val();
    const env = $("#environment").val();
    apiBasePath = user_bank_settings?.[bank]?.[env]?.[this.value]?.url;
    currentProject = this.value;
    if (!!this.value) {
      console.log("project changed", this.value);
      getAllConfigurations();
      $("#splashScreen").hide();
    }
  });
  $(document).on("change", "#bankName, #environment, #project", function () {
    $("#bankName, #environment, #project").map(function () {
      if (!this.value) {
        $("#main-table").html("");
        $("#splashScreen").show();
      }
    });
  });

  function getAllConfigurations() {
    if (lock == true) return;
    $("#divLoader").show();
    lock = true;
    const bank = $("#bankName").val();
    const env = $("#environment").val();
    const project = $("#project").val();
    const postParamsData = {};
    if (
      user_bank_settings?.[bank]?.[env]?.[project]?.url_params?.post &&
      Array.isArray(
        user_bank_settings?.[bank]?.[env]?.[project]?.url_params?.post
      )
    ) {
      user_bank_settings?.[bank]?.[env]?.[project]?.url_params?.post.forEach(
        (el) => {
          postParamsData[el.key] = el.value;
        }
      );
    }
    $.ajax({
      url: apiBasePath + "/api/cms/v1/get_all_config/",
      type: "POST",
      data: JSON.stringify({ ...postParamsData }),
      success: function (response) {
        lock = false;
        if (response?.success) {
          var tableHtml = "";
          console.log(response?.data);
          const configData = response?.data;
          let move_to_prod_enabled =
            !!(currentEnvironment == "UAT") &&
            !!(
              user_bank_settings[currentBank]["PROD"] &&
              user_bank_settings[currentBank]["PROD"][currentProject]
            );
          currentActiveConfigs = [];
          for (var i = 0; i < configData.length; i++) {
            tableHtml +=
              "<tr><td>" +
              (!!configData[i]["uid"] ? configData[i]["uid"] : "NA") +
              "</td><td>" +
              (!!configData[i]["conf_key"] ? configData[i]["conf_key"] : "NA") +
              "</td><td>" +
              (!!configData[i]["version"] ? configData[i]["version"] : "NA") +
              "</td><td>" +
              (!!configData[i]["active"] ? "Active" : "Inactive") +
              "</td><td>" +
              (!!configData[i]["user"] ? configData[i]["user"] : "NA") +
              "</td><td>" +
              (!!configData[i]["created_time"]
                ? configData[i]["created_time"]
                : "NA") +
              "</td><td>" +
              `<button type="button" onclick="handleConfigCtaClick('view','${configData[i]["conf_key"]}','${configData[i]["version"]}')" class="btn btn-block btn-success waves-effect waves-themed">View</button>` +
              "</td><td>" +
              `<button type="button" onclick="handleConfigCtaClick('edit','${configData[i]["conf_key"]}','${configData[i]["version"]}')" class="btn btn-block btn-warning waves-effect waves-themed">Edit</button>` +
              "</td>" +
              (move_to_prod_enabled
                ? `<td><button type="button" onclick="moveSingleConfigToProdCtaClick('${configData[i]["conf_key"]}','${configData[i]["version"]}')" class="btn btn-block btn-danger waves-effect waves-themed">Move To Prod</button></td>`
                : "") +
              "</tr>";

            if (configData[i]["active"]) {
              currentActiveConfigs.push(configData[i]);
            }
          }
          $("#invoices-data-div").show();

          $("#main-table").html(
            _.template($("#table-template").text(), {
              table_html: tableHtml,
              table_id: tableCounter,
              prod_access: move_to_prod_enabled,
            })
          );
          initDatatable();
          $("#divLoader").hide();
        } else {
          $("#divLoader").hide();
          console.log("Api success false");
          $("#somethingWentWrongAlert").toast("show");
          $("#main-table").html("");
          $("#splashScreen").show();
        }
      },
      error: function (error) {
        lock = false;
        $("#divLoader").hide();
        $("#somethingWentWrongAlert").toast("show");
        $("#main-table").html("");
        $("#splashScreen").show();
      },
    });
  }
  async function moveToProd() {
    const selectedActiveConfs = currentActiveConfigs.filter(
      (el) => !!$(`#${el?.conf_key}_checkbox`).is(":checked")
    );

    if (!selectedActiveConfs?.length) {
      alert("No selected config found");
      return;
    }
    $("#screenLoader").show();
    const apiCalls = selectedActiveConfs.map((conf) => {
      return moveConfigToProduction(conf["conf_key"], conf["version"], true);
    });

    try {
      await Promise.all(apiCalls);

      console.log("all api calls done");
      $("#screenLoader").hide();
      $("#moveToProdModal").modal("hide");
      $("#successAlert").toast("show");
    } catch (error) {
      $("#screenLoader").hide();
      console.error(error);
    }
  }
  function handleConfigCtaClick(mode, key, version) {
    const bank = $("#bankName").val();
    const env = $("#environment").val();
    const project = $("#project").val();
    var configLink = `${window.location.origin}/mentis/editor/?#addConfiguration?mode=${mode}&bank=${bank}&env=${env}&project=${project}&conf_key=${key}&conf_version=${version}`;
    window.open(configLink, "_blank");
  }


  function updateProfile(){
    const name = $("#name").val();
    const registration_number = $("#registration_number").val();
    const experience_years = $("#experience_years").val();
    const experience_months = $("#experience_months").val();
    const specialisations = $("#specialisations").val();
    const languages = $("#languages").val();
    const city = $("#city").val();
    const coord = [lat,lng];
    const location_meta = JSON.Stringify({
    "coord":coord,
    "embed_map":embedLink,
    "google_link";shareLink,
    "address":address})

    const about_me = $("#about_me").val();
    const fileList = $("#photo")[0].files;
    console.log(fileList.length);
    var extra_info = {};
    extra_info["about_me"]= about_me;
    extra_info["languages"]= languages;


    var specialisation = {};
    specialisation["specialisations"]= specialisations;
    var imageData = "";

    if (fileList.length > 0){
    var img_name = $("#photo")[0].files[0].name;

    var fileReader = new FileReader();
    fileReader.readAsDataURL(fileList[0]);
      fileReader.onload = function () {
         imageData = fileReader.result;
         var data = {
        "name":name,
        "city":city,
        "location_meta":location_meta,
        "registration_number":registration_number,
        "experience_years":experience_years,
        "experience_months":experience_months,
        "extra_info":JSON.stringify(extra_info),
        "specialisation":JSON.stringify(specialisation),
        "img":imageData,
        "img_name":img_name,
        "active":$("#active").is(":checked")
        }
     console.log(imageData);

     console.log(JSON.stringify(data));

     $.ajax({
              url: "/dsh/update_profile/",
              type: "POST",
              data: JSON.stringify(data),
              contentType: "application/json",
              success: function (response) {
                lock = false;
                if (response?.success) {
                  if (!moveAll) {
                    $("#divLoader").hide();
                    $("#successAlert").toast("show");
                  }
                } else {
                  if (moveAll) {
                    $("#screenLoader").hide();
                  } else {
                    $("#divLoader").hide();
                  }
                  $("#somethingWentWrongAlert").toast("show");
                }
              },
              error: function (error) {
                lock = false;
                if (moveAll) {
                  $("#screenLoader").hide();
                } else {
                  $("#divLoader").hide();
                }
                $("#somethingWentWrongAlert").toast("show");
              },
            });
      };
      }
      else{

      var data = {
        "name":name,
        "city":city,
        "location_meta":location_meta,
        "registration_number":registration_number,
        "experience_years":experience_years,
        "experience_months":experience_months,
        "extra_info":JSON.stringify(extra_info),
        "specialisation":JSON.stringify(specialisation),
         "active":$("#active").is(":checked")
        }

     console.log(JSON.stringify(data));

     $.ajax({
              url: "/dsh/update_profile/",
              type: "POST",
              data: JSON.stringify(data),
              contentType: "application/json",
              success: function (response) {
                lock = false;
                if (response?.success) {
                    $("#divLoader").hide();
                    $("#successAlert").toast("show");

                } else {

                  $("#somethingWentWrongAlert").toast("show");
                }
              },
              error: function (error) {
                lock = false;

                $("#somethingWentWrongAlert").toast("show");
              },
            });


      }


  }

  function initDatatable() {
    $("#datatable-invoice-data-1").dataTable({
      responsive: true,
      lengthChange: false,
      dom:
        /*	--- Layout Structure
            --- Options
            l	-	length changing input control
            f	-	filtering input
            t	-	The table!
            i	-	Table information summary
            p	-	pagination control
            r	-	processing display element
            B	-	buttons
            R	-	ColReorder
            S	-	Select

            --- Markup
            < and >				- div element
            <"class" and >		- div with a class
            <"#id" and >		- div with an ID
            <"#id.class" and >	- div with an ID and a class

            --- Further reading
            https://datatables.net/reference/option/dom
            --------------------------------------
         */
        "<'row mb-3'<'col-sm-12 col-md-6 d-flex align-items-center justify-content-start'f><'col-sm-12 col-md-6 d-flex align-items-center justify-content-end'lB>>" +
        "<'row'<'col-sm-12'tr>>" +
        "<'row'<'col-sm-12 col-md-5'i><'col-sm-12 col-md-7'p>>",
      buttons: [
        /*{
              extend:    'colvis',
              text:      'Column Visibility',
              titleAttr: 'Col visibility',
              className: 'mr-sm-3'
          },*/
        {
          extend: "pdfHtml5",
          text: "PDF",
          titleAttr: "Generate PDF",
          className: "btn-outline-danger btn-sm mr-1",
        },
        {
          extend: "excelHtml5",
          text: "Excel",
          titleAttr: "Generate Excel",
          className: "btn-outline-success btn-sm mr-1",
        },
        {
          extend: "csvHtml5",
          text: "CSV",
          titleAttr: "Generate CSV",
          className: "btn-outline-primary btn-sm mr-1",
        },
        {
          extend: "copyHtml5",
          text: "Copy",
          titleAttr: "Copy to clipboard",
          className: "btn-outline-primary btn-sm mr-1",
        },
        {
          extend: "print",
          text: "Print",
          titleAttr: "Print Table",
          className: "btn-outline-primary btn-sm",
        },
      ],
    });
  }

  var lock = false;

  function moveConfigToProduction(configKey, configVersion, moveAll = false) {

    lock = true;
    $.ajax({
              url: "/mentis/editor/migrate_config/",
              type: "POST",
              data: JSON.stringify({"config_key":configKey,"config_version":configVersion,"source":{"env":"UAT","bank":currentBank,"project":currentProject} ,"destination":{"env":"PROD","bank":currentBank,"project":currentProject}}),
              contentType: "application/json",
              success: function (response) {
                lock = false;
                if (response?.success) {
                  if (!moveAll) {
                    $("#divLoader").hide();
                    $("#successAlert").toast("show");
                  }
                } else {
                  if (moveAll) {
                    $("#screenLoader").hide();
                  } else {
                    $("#divLoader").hide();
                  }
                  $("#somethingWentWrongAlert").toast("show");
                }
              },
              error: function (error) {
                lock = false;
                if (moveAll) {
                  $("#screenLoader").hide();
                } else {
                  $("#divLoader").hide();
                }
                $("#somethingWentWrongAlert").toast("show");
              },
            });
  }


  function moveConfigToProductionV2(configKey, configVersion, moveAll = false) {
    var apiBasePath =
      user_bank_settings[currentBank]["UAT"][currentProject]["url"];
    lock = true;
    if (moveAll) {
      $("#screenLoader").show();
    } else {
      $("#divLoader").show();
    }
    const bank = $("#bankName").val();
    const env = $("#environment").val();
    const project = $("#project").val();
    const postParamsData = {};
    if (
      user_bank_settings?.[bank]?.[env]?.[project]?.url_params?.post &&
      Array.isArray(
        user_bank_settings?.[bank]?.[env]?.[project]?.url_params?.post
      )
    ) {
      user_bank_settings?.[bank]?.[env]?.[project]?.url_params?.post.forEach(
        (el) => {
          postParamsData[el.key] = el.value;
        }
      );
    }
    return new Promise((resolve, reject) => {
      $.ajax({
        url: apiBasePath + "/api/cms/v1/get_config_from_key/",
        // url: "http://demo5867723.mockable.io/get_config_from_key  ",
        type: "POST",
        data: JSON.stringify({
          ...postParamsData,
          key: configKey,
          version: configVersion,
        }),
        contentType: "application/json",
        success: function (response) {
          console.log("response", response);
          if (response?.success) {
            const prodUrl =
              user_bank_settings[currentBank]["PROD"][currentProject]["url"];
            var configData = {
              user: currentUser,
              key: configKey,
              conf_value: response["data"]["conf_val"],
              diff_meta: response["data"]["diff_meta"],
            };
            $.ajax({
              url: prodUrl + "/api/cms/v1/create_update_config/",
              type: "POST",
              data: JSON.stringify({ ...configData, ...postParamsData }),
              contentType: "application/json",
              success: function (response) {
                lock = false;
                if (response?.success) {
                  resolve();
                  if (!moveAll) {
                    $("#divLoader").hide();
                    $("#successAlert").toast("show");
                  }
                } else {
                  if (moveAll) {
                    $("#screenLoader").hide();
                  } else {
                    $("#divLoader").hide();
                  }
                  $("#somethingWentWrongAlert").toast("show");
                }
              },
              error: function (error) {
                lock = false;
                if (moveAll) {
                  $("#screenLoader").hide();
                } else {
                  $("#divLoader").hide();
                }
                $("#somethingWentWrongAlert").toast("show");
              },
            });
          } else {
            if (moveAll) {
              $("#screenLoader").hide();
            } else {
              $("#divLoader").hide();
            }
            $("#somethingWentWrongAlert").toast("show");
          }
        },
        error: function (error) {
          lock = false;
          // $("#screenLoader").hide();
          if (moveAll) {
            $("#screenLoader").hide();
          } else {
            $("#divLoader").hide();
          }
          $("#somethingWentWrongAlert").toast("show");
        },
      });
    });
  }



  function moveSingleConfigToProdCtaClick(conf_key, conf_version) {
    console.log(conf_key, conf_version);
    $("#confirmationModalConfigKey").data("conf_key", `${conf_key}`);
    $("#confirmationModalConfigKey").data("conf_version", `${conf_version}`);
    // $("#confirmationModalConfigKey").html(`conf_key : ${conf_key}, conf_version : ${conf_version}`)
    $("#moveToProdConfirmationModal").modal();
  }
  function confirmAndProceed(conf_key, conf_version) {
    $("#moveToProdConfirmationModal").modal("hide");
    moveConfigToProduction(
      $("#confirmationModalConfigKey").data("conf_key"),
      $("#confirmationModalConfigKey").data("conf_version")
    );
    $("#confirmationModalConfigKey").data("conf_key", "");
    $("#confirmationModalConfigKey").data("conf_version", "");
  }
  $("#moveToProdConfirmationModal").on("hidden.bs.modal", function (e) {
    $("#confirmationModalConfigKey").data("conf_key", "");
    $("#confirmationModalConfigKey").data("conf_version", "");
  });
  function moveAllToProdButtonClick() {
    $("#moveToProdModal").modal();
    var selectedActiveConfig = currentActiveConfigs;
    var tableHtml = "";
    for (var i = 0; i < currentActiveConfigs.length; i++) {
      tableHtml += `<tr>
                  <td>${currentActiveConfigs?.[i]?.conf_key}</td>
                  <td>${currentActiveConfigs?.[i]?.version}</td>
                  <td>${currentActiveConfigs?.[i]?.user}</td>
                  <td><input id="${currentActiveConfigs?.[i]?.conf_key}_checkbox" type="checkbox" style="accent-color: #7a59ad;height: 20px;width: 20px;cursor: pointer;" checked></td>
              </tr>`;
    }

    $("#currentActiveConfigTable").html(tableHtml);
  }

  function moveAllConfigToProduction() {
    if (currentActiveConfigs.length == 0) {
      alert("No active configs found");
      return;
    }

    for (var i = 0; i < currentActiveConfigs.length; i++) {
      moveConfigToProduction(
        currentActiveConfigs[i]["conf_key"],
        currentActiveConfigs[i]["version"]
      );
    }

    alert("Done");
  }
</script>
